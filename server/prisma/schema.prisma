generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  PATIENT
  DOCTOR
  PHARMACIST
  LAB_SCIENTIST
  RIDER
  ADMIN
  SARC_OFFICER
}

model User {
  id        String   @id @default(uuid())
  publicId  String   @unique // The #GH-xxxx-LAG ID
  role      Role     @default(PATIENT)
  
  // PII (Hashed/Encrypted)
  dataHash  String?  // Hashed combination of phone/name for lookup
  encryptedData String? // Encrypted JSON blob of real name, phone, etc.
  
  // OAuth Identifiers
  googleId  String?  @unique
  appleId   String?  @unique
  
  // Profile (Public/Ghost)
  age       Int?
  sex       String?
  avatar    String?
  nickname  String?
  
  // Doctor-specific
  isOnline       Boolean  @default(false)
  specialization String?

  // Auth
  refreshToken   String?

  // Wallet
  walletBalance  Float    @default(0.0)

  // Soft delete
  deletedAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  consultationsAsPatient Consultation[] @relation("PatientConsultations")
  consultationsAsDoctor  Consultation[] @relation("DoctorConsultations")
  orders                 Order[]
  transactions           Transaction[]
  notifications          Notification[]

  @@index([dataHash])
  @@index([role])
  @@index([isOnline, role])
}

model Transaction {
  id          String   @id @default(uuid())
  amount      Float
  type        String   // CONSULTATION, MEDICATION
  status      String   // SUCCESS, FAILED
  payerId     String
  payeeId     String?
  
  platformFee Float
  netAmount   Float
  
  payer       User     @relation(fields: [payerId], references: [id])
  createdAt   DateTime @default(now())

  @@index([payerId])
}

model Consultation {
  id        String   @id @default(uuid())
  patientId String
  doctorId  String?
  status    String   @default("PENDING") // PENDING, ACTIVE, COMPLETED
  
  patient   User     @relation("PatientConsultations", fields: [patientId], references: [id])
  doctor    User?    @relation("DoctorConsultations", fields: [doctorId], references: [id])
  
  messages  Message[]
  prescriptions Prescription[]

  // Soft delete
  deletedAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([patientId])
  @@index([doctorId])
}

model Message {
  id             String   @id @default(uuid())
  consultationId String
  senderId       String
  content        String
  isSystem       Boolean  @default(false)
  createdAt      DateTime @default(now())
  
  consultation   Consultation @relation(fields: [consultationId], references: [id])

  @@index([consultationId])
}

model Prescription {
  id             String   @id @default(uuid())
  consultationId String
  medications    Json     // Array of drug names/dosages
  status         String   @default("PENDING") // PENDING, FULFILLED
  createdAt      DateTime @default(now())
  
  consultation   Consultation @relation(fields: [consultationId], references: [id])
  order          Order?

  @@index([consultationId])
}

model Order {
  id             String   @id @default(uuid())
  publicOrderId  String   @unique // #ORD-xxxx
  prescriptionId String?  @unique
  patientId      String
  
  status         String   @default("PENDING") // PENDING, PROCESSING, READY_FOR_PICKUP, PICKED_UP, DELIVERED
  pharmacyId     String?  // ID of the pharmacy handling it
  riderId        String?  // ID of the rider
  
  secureCode     String?  // 4-digit code for handover
  deliveryAddress String? // Address for delivery (can be generic/locker)

  // Soft delete
  deletedAt      DateTime?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  patient        User     @relation(fields: [patientId], references: [id])
  prescription   Prescription? @relation(fields: [prescriptionId], references: [id])

  @@index([status])
  @@index([patientId])
  @@index([pharmacyId])
  @@index([riderId])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String   // CONSULTATION, PRESCRIPTION, ORDER, SYSTEM
  title     String
  body      String
  read      Boolean  @default(false)
  
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())

  @@index([userId, read])
  @@index([userId, createdAt])
}
